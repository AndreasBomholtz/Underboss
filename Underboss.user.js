// ==UserScript==
// @name        The Underboss
// @namespace   Underboss
// @author      MrAnderson
// @description A bot for the game The Godfather from kabam.com
// @include     https://www.kabam.com/games/the-godfather/play*
// @include     https://www.kabam.com/*/games/the-godfather/play*
// @include     https://*godfather.*.com/platforms/kabam/game*
// @version     2.0.3
// @grant       GM_addStyle
// @grant       GM_getResourceText
// @downloadURL https://raw.githubusercontent.com/AndreasBomholtz/Underboss/master/Underboss.user.js
// require     http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js
// @resource    underbossCSS res/underboss.css
// ==/UserScript==
function convertToText(t){var e=[];if("object"==typeof t&&void 0==t.join){e.push("{");for(prop in t)e.push(prop,": ",convertToText(t[prop]),",");e.push("}")}else if("object"==typeof t&&void 0!=t.join){e.push("[");for(prop in t)e.push(convertToText(t[prop]),",");e.push("]")}else"function"==typeof t?e.push(t.toString()):e.push(JSON.stringify(t));return e.join("")}function inject(t){var e=document.createElement("script");e.innerHTML=t,e.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(e)}function injectFunction(t){t="("+t.toString()+")();",inject(t)}function injectVariable(t,e){e="var "+t+" = "+JSON.stringify(e)+";",inject(e)}function injectObject(t,e){e="var "+t+" = "+e.toString()+";",inject(e)}function injectScript(t){var e=document.createElement("script");e.src=t,document.getElementsByTagName("head")[0].appendChild(e)}function combine(t){for(var e=arguments.length,i=1;e>i;i++){var s=arguments[i];if(void 0!==s)for(var a=Object.keys(s),n=a.length,r=0;n>r;r++){var o=a[r];t[o]=s[o]}}return t}var attackUnits={Thug:{cost:{cash:750,food:281,steel:563,cement:281,influence:10},bailout:2250},Arsonist:{requirement:{research:{Logistics:1},build:{Hideout:2}},bailout:3300},Demolitionist:{requirement:{research:{Proficiency:4},build:{Garage:3,Hideout:3}},bailout:5100},Bruiser:{requirement:{research:{Corruption:6},build:{Workshop:3,Hideout:4}},bailout:8100},Hitman:{requirement:{research:{Corruption:7,Proficiency:7},build:{Hideout:6,Workshop:5,Garage:5}}},Enforcer:{requirement:{research:{Proficiency:8},build:{Garage:6,Hideout:7}},bailout:17100},TommyGunner:{requirement:{research:{Corruption:10},build:{Workshop:6,Hideout:8}}},Professional:{requirement:{research:{Proficiency:12},build:{Garage:9,Hideout:9}}},Sniper:{requirement:{research:{Corruption:14,Proficiency:14},build:{Hideout:9,Workshop:9,Garage:9}},bailout:46800},Butcher:{requirement:{research:{Corruption:16,Cooking:17},build:{Workshop:9,Hideout:9}}},BlackWidow:{requirement:{research:{Corruption:17},build:{Hideout:9,Workshop:9}},bailout:56628},Assassin:{requirement:{research:{Proficiency:17},build:{Hideout:9,Garage:9}},bailout:56628},Courier:{cost:{cash:500,food:188,steel:188,cement:375,influence:10}},DeliveryTruck:{requirement:{research:{Mechanics:6,Capacity:8},build:{Hideout:5,Garage:2}}},Smuggler:{bailout:62292},Undertaker:{bailout:62292},Doctor:{bailout:62292},Loanshark:{bailout:62292},Hatchetman:{bailout:62292},Triggerman:{bailout:62292},Bartender:{bailout:62292},Crookedcop:{bailout:68520},DRC:{bailout:68520},PIG:{bailout:68520},Highbinder:{bailout:68520},Gman:{bailout:68520},Bookie:{bailout:68520},MisterSnip:{bailout:75e3},MisterHaul:{bailout:75e3},MisterFixit:{bailout:75e3},MisterSplit:{bailout:75e3},MisterKippy:{bailout:75e3},MisterPao:{bailout:75e3}},buildings={SteelMill:{buildNew:1,cost:{cash:600,food:200,steel:200,cement:500}},Restaurant:{buildNew:1,cost:{cash:600,food:200,steel:500,cement:200}},CementFactory:{buildNew:1,cost:{cash:600,food:500,steel:200,cement:200}},Apartment:{buildNew:6,cost:{cash:500,food:100,steel:100,cement:100}},Hideout:{cost:{cash:1200,food:500,steel:500,cement:500}},Mansion:{priority:1,requirement:{build:{5:{Wall:5},7:{Wall:7},8:{Wall:8}}},cost:{cash:2500,food:300,steel:300,cement:300}},Library:{priority:2,cost:{cash:2500,food:1500,steel:200,cement:200}},Warehouse:{requirement:{gangster:4},cost:{cash:1500,food:1e3,steel:300,cement:300}},Garage:{requirement:{build:{2:{Restaurant:5}},gangster:9},cost:{cash:2e3,food:300,steel:1e3,cement:300}},Armory:{requirement:{gangster:3},cost:{cash:3e3,food:300,steel:300,cement:1e3}},Workshop:{requirement:{gangster:7},cost:{cash:3e3,food:300,steel:1e3,cement:300}},GuestHouse:{requirement:{gangster:6},cost:{cash:2e3,food:500,steel:300,cement:300}},Wall:{cost:{cash:6e3,food:1e3,steel:1e3,cement:1e3}},GuardPost:{requirement:{build:{0:{SteelMill:3}},gangster:8},cost:{cash:1500,food:300,steel:300,cement:1e3}},Vault:{requirement:{gangster:3},cost:{cash:3e3,food:300,steel:300,cement:1e3}},FrontGate:{requirement:{gangster:5},cost:{cash:1500,food:500,steel:1500,cement:500}},Exchange:{priority:2,requirement:{build:{2:{GuestHouse:3}}},cost:{cash:3e3,food:300,steel:300,cement:1e3}}},collect=["KickbackBundle100","KickbackBundle250","KickbackBundle1000","KickbackBundle3000","AppointmentBundle100","AppointmentBundle250","AppointmentBundle1000","AppointmentBundle3000","FavorBundle100","FavorBundle250","FavorBundle1000","FavorBundle3000","AssortedResourcesBundle","InitiateBundle","TributeTicketBundle10"],defenseUnits={BarbedWire:{requirement:{research:{Logistics:4},build:{GuardPost:2,Wall:2}}},BoobyTrap:{requirement:{research:{Logistics:8},build:{GuardPost:4,Wall:4}}},GuardDog:{requirement:{research:{Logistics:12},build:{GuardPost:6,Wall:6}}},ArmedGuard:{requirement:{research:{Logistics:14},build:{GuardPost:7,Wall:7}}},Bodyguard:{requirement:{research:{Logistics:16},build:{GuardPost:8,Wall:8}}},UnnamedDefender:{requirement:{research:{Logistics:18},build:{GuardPost:9,Wall:9}}}},prizes={SpeedUp1Minute:1,SpeedUp5Minute:3,SpeedUp15Minute:5,SpeedUp1Hour:10,SpeedUp2HalfHour:15,SpeedUp8Hour:40,SpeedUp15Hour:65,SpeedUp24Hour:95,AttackBoost24Hour:10,SteelBoost24Hour:7,CementBoost24Hour:7,FoodBoost24Hour:7,CashBoost24Hour:35,SpeedUpTraining30Percent:35,SteelBoost1Week:40,FoodBoost1Week:40,CementBoost1Week:40,OliveBranch12Hour:25,OliveBranch24Hour:40,HealthBoost24Hour:10,AttackBoost7Day:35,HealthBoost7Day:35,RelocationProgram:30,WreckingBall:7,ChangeEstateName:9,Perfume:25,Energizer:5,SlickStitch:10,BoxingTicket:2,TokenOfServitude:10,GreenwichVillageDeed:150,ParkAveDeed:300,BrooklynDeed:300,AtlanticCityDeed:35,ChinatownDeed:35,RookieBundle:40,DonsBlessing:40,InitiateBundle:10,DonsBlessing11:40,ZoningPermit:40,ContractBundle100:1,ContractBundle500:2,ContractBundle1000:5,FavorBundle100:1,FavorBundle500:2,FavorBundle1000:5,FavorBundle3000:15,KickbackBundle100:1,KickbackBundle500:3,KickbackBundle1000:5,BruiserBundle25:10,EnforcerBundle25:10,DemolitionistBundle25:10,ArmedGuardBundle100:10,ThugBundle25:5,HitmanBundle25:10,AssassinBundle25:10,GuardDogBundle100:10,ProfessionalBundle25:10,BlackWidowBundle25:10,BlackWidowBundle100:20,AssassinBundle100:20,UnnamedDefenderBundle100:10,ArsonistBundle25:10,SniperBundle25:10,ButcherBundle25:10,TommyGunnerBundle25:10,BodyguardBundle100:10,AppointmentBundle100:20,AppointmentBundle500:75,AppointmentBundle1000:135,AppointmentBundle3000:300,LesserAttireMedallion:40,GreaterAttireMedallion:95,GreaterLuckyToken:12,PoisonHealth10Percent10Minutes:10,PoisonHealth25Percent10Minutes:20,ColesMotorOil:35,BronzeToolbox:40,GoldToolbox:75,Antidote:35,BronzeBuildingPermit:40,SilverBuildingPermit:60,GoldBuildingPermit:75,AssortedResourcesBundle:10,UpgradeGuarantee5:30,UpgradeGuarantee7:30,PromoteGuarantee1:30,PromoteGuarantee2:30,PromoteGuarantee3:30,PromoteGuarantee4:30,PromoteGuarantee5:30,PromoteGuarantee6:30,PromoteGuarantee7:30,BankHeistStamp:30,AssortedResources250KBundle:10},research={Capacity:{priority:4,requirement:{research:["Cooking","Cementing","Steelwork"]},cost:{cash:250,food:175,steel:175,cement:175}},Carjacking:{priority:5,requirement:{research:["Capacity"],build:"Garage"},cost:{cash:400,food:200,steel:200,cement:200}},Cementing:{priority:2,requirement:{research:["Logistics"],build:"CementFactory"},cost:{cash:150,food:100,steel:100,cement:200}},Construction:{priority:4,requirement:{research:["Maneuver"]},cost:{cash:400,food:200,steel:200,cement:200}},Cooking:{priority:2,requirement:{research:["Logistics"],build:"Restaurant"},cost:{cash:150,food:200,steel:100,cement:100}},Corruption:{priority:5,requirement:{research:["Capacity"],build:"Hideout"},cost:{cash:400,food:200,steel:200,cement:200}},Logistics:{priority:1,requirement:{research:[],build:"Library"},cost:{cash:225,food:150,steel:300,cement:150}},Maneuver:{priority:3,requirement:{research:["Spying"],build:"Garage"},cost:{cash:250,food:175,steel:175,cement:175}},Mechanics:{priority:4,requirement:{research:["Trafficking"]},cost:{cash:250,food:175,steel:175,cement:175}},Medicine:{priority:6,requirement:{research:["Construction","Corruption"]},cost:{cash:500,food:250,steel:250,cement:250}},Muscle:{priority:6,requirement:{research:["Proficiency","Mechanics"],Build:"GaurdPost"},cost:{cash:500,food:250,steel:250,cement:250}},Proficiency:{priority:5,requirement:{research:["Mechanics"],build:"Workshop"},cost:{cash:400,food:200,steel:200,cement:200}},Spying:{priority:2,requirement:{research:["Logistics"]},cost:{cash:200,food:150,steel:150,cement:150}},Steelwork:{priority:2,requirement:{research:["Logistics"],build:"SteelMill"},cost:{cash:150,food:100,steel:200,cement:100}},Trafficking:{priority:3,requirement:{research:["Cooking","Cementing","Steelwork"]},cost:{cash:200,food:150,steel:150,cement:150}}},attackBot={updateMap:function(){if(this.trace(),this.cities&&this.cities[0]&&this.cities[0].data){this.options.map_size+=2;var t=10*((this.options.map_size-1)/2);this.options.map_loaded||(this.options.map_loaded={});for(var e=0;e<this.cities.length;e++){var i=this.cities[e];if(i&&i.data){var s=i.x-t;0>s&&(s=750+s);var a=i.y-t;0>a&&(a=750+a);for(var n=0;n<this.options.map_size;n++)for(var r=0;r<this.options.map_size;r++){var o=(s+10*n)%750,d=(a+10*r)%750;this.options.map_loaded[o]||(this.options.map_loaded[o]={}),this.options.map_loaded[o][d]?this.debugAttack("Not reloading ("+o+","+d+")"):(this.options.map_loaded[o][d]=!0,this.debugAttack("Get map ("+o+","+d+")"),this.sendSlowGetCommand("Get map ("+o+","+d+")","map.json","x="+o+"&y="+d,i,this.bind(this.drawMapInfo)))}this.saveOptions()}}}else setTimeout(this.bind(this.updateMap),1e3)},findBestGang:function(t,e){this.trace(),this.debugAttack("FindBestGang for "+t.type+" with lvl "+e);var i=new Date,s={lvl:0},a=1e3;for(var n in this.options.map)for(var r in this.options.map[n]){var o=this.options.map[n][r];if((o.lvl==e||e>1&&o.lvl==e-1)&&(!o.attacked||o.attacked<i.getTime())){var d=Math.abs(n-t.x);d>250&&(d=Math.abs(750-d));var l=Math.abs(r-t.y);l>250&&(l=Math.abs(750-l)),(s.lvl<o.lvl||a>d+l&&s.lvl===o.lvl)&&(a=d+l,s=o,this.debugAttack("Found better Gang "+s.lvl+" at ("+n+","+r+") with dist ("+d+" + "+l+") = "+a))}}return s},doAttack:function(){this.trace();var t=6e4,e=new Date;if(!this.cities||!this.cities[0]||!this.cities[0].data)return 1e3;if(!this.options.map)return this.updateMap(),1e4;if(this.cities&&this.options.attackOrders)for(var i=0;i<this.cities.length;i++){var s=this.cities[i];if(s&&s.data&&s.energy>1){for(var a={gang:0},n=0;n<this.options.attackOrders.length;n++){var r=this.options.attackOrders[n];this.debugAttack("Order: "+r.gang+" City: "+r.city+" Units: "+r.units,s);var o=!1;if(r.city&&"all"!=r.city&&r.city!=s.type?this.debugAttack("Wrong city",s):o=!0,o){var d=JSON.parse(r.units);for(var l in d)if(!s.data.units[l]||s.data.units[l]<d[l]){this.debugAttack("Do not have "+l+" ("+d[l]+")",s),o=!1;break}}if(o){var u=parseInt(a.gang,10),h=parseInt(r.gang,10);h>u&&(a=r)}}if(a.units){var c=this.findBestGang(s,a.gang);if(c.lvl>0){this.debugAttack("Attack "+c.lvl+" Gang at ("+c.x+","+c.y+")",s),c.lvl<=10&&(c.attacked=e.getTime()+18e5);var p=a.units;a.use_all&&(p=this.getAttackUnits(s)),this.attack(c.x,c.y,p,s),t=6e5,this.saveOptions()}else this.debugAttack("Failed to find a gang to attack",s)}}else this.debugAttack("No more energy",s)}else this.debugAttack("City or orders not ready");return t},getAttackUnits:function(t){if(this.trace(),t&&t.data&&t.data.units){var e=jQuery.extend(!0,{},t.data.units);for(var i in defenseUnits)e[i]&&delete e[i];var s=0;for(var a in e)s<t.maximum_troops?(e[a]>t.maximum_troops-s&&(e[a]=t.maximum_troops-s),this.debugAttack("Add attack units "+a+" => "+e[a]+" ("+s+"/"+t.maximum_troops+")",t),s+=e[a]):delete e[a];return JSON.stringify(e)}return""},attack:function(t,e,i,s){this.trace(),this.sendCommand("Attack ("+t+","+e+") from "+s.type,"cities/"+s.id+"/marches.json","_method=post&march[x]="+t+"&march[y]="+e+"&march[units]="+i,s),this.addStat("Attack",1)}},bailoutBot={doBailout:function(){if(this.trace(),this.cities)for(var t=0;t<this.cities.length;t++){var e=this.cities[t];"DoriaAirport"!=e.type&&this.sendGetCommand("Update bail","cities/"+e.id+"/cash_jail.json","",e)}},payBailout:function(t){if(this.trace(),t)if(t.bailout){var e=0;t.data&&t.data.resources?e=parseInt(t.data.resources.cash,10):this.debugBailout("No resources",t);var i="",s="",a=0;for(var n in t.bailout){var r=0;if(attackUnits[n]&&attackUnits[n].bailout){var o=attackUnits[n].bailout,d=parseInt(t.bailout[n],10),l=o*d;this.debugBailout(n+" costs "+l+" and all units costs "+a+" and I have "+e,t);var u=parseInt((e-a)/o,10);if(u>0){u=u>d?d:u;var h=u*o;this.debugBailout("I can affort "+u+" "+n+" because it cost "+h+" and I have "+(e-a)+" ("+e+")",t),r=u,a+=h}else this.debugBailout("Can't affort "+n+" because it cost "+o+" and I have "+(e-a)+" ("+e+")",t)}else this.debug("Missing bailout for "+n,t);r>0&&(i+="&units["+n+"]="+r,s+=r+" "+n+", ")}t.bailout={},""!==i?(this.debugBailout(s,t),this.sendCommand("Pay Bailout in "+t.type,"cities/"+t.id+"/cash_jail/bail.json","payment_method=cash"+i,t)):this.debugBailout("No bailout data to send",t)}else this.debugBailout("No bailout",t);else this.debugBailout("City is missing")}},bondsBot={doBonds:function(){if(this.debugBonds("Get Bonds"),this.cities){var t=this.cities[0];this.sendGetCommand("Get Bonds","bonds.json","action=index",t)}},handleBonds:function(){if(this.debugBonds("Handle bonds"),this.cities){var t=this.cities[0];this.sendCommand("Collect Bonds","bonds/redeem.json","action=index",t)}}},bot={autoFunctions:{Collect:{},Build:{},Research:{},Attack:{},Bailout:{},Train:{},Defense:{},Prize:{},LoyaltyToken:{},Cityscape:{},Exchange:{},Items:{},Report:{},Bonds:{}},bind:function(t){if(t){var e=this;return function(){return t.apply(e,arguments)}}},signal:function(t){$(document).trigger(t)},listen:function(t,e){$(document).bind(t,this.bind(e))},generateChangeEnable:function(t){this["changeEnable"+t]=function(){this.options["enable"+t]=this.html["enable_"+t].checked,this.saveOptions(),this.debug("Enable "+t+": "+this.options["enable"+t])}},generateAutoThread:function(t){this["auto"+t+"Thread"]=function(){var e=this.bind(this["auto"+t+"Thread"]),i=6e4;if(this.cities&&this.options["enable"+t]){var s=this["do"+t]();s&&(i=s)}setTimeout(e,i)},this["auto"+t+"Thread"]()},generateDebugEnable:function(t){this["changeDebugEnable"+t]=function(){this["enableDebug"+t]=this.html["enable_debug_"+t].checked,this.debug("Enable Debug "+t+": "+this["enableDebug"+t])}},getCity:function(t){if(this.cities)for(var e=0;e<this.cities.length;e++)if(this.cities[e].id==t)return this.cities[e];return void 0},findBuildingLevel:function(t,e){var i=0;if(e&&e.neighborhood&&e.neighborhood.length)for(var s=0;s<e.neighborhood.length;s++){var a=e.neighborhood[s];if(a&&a.buildings)for(var n=a.buildings,r=0;r<n.length;r++)n[r].type==t&&i<n[r].level&&(i=n[r].level)}return i},countBuilding:function(t,e){this.trace();var i=0;if(t&&t.buildings)for(var s=t.buildings,a=0;a<s.length;a++)"neighborhood"==s[a].location&&(void 0!==e||s[a].hasOwnProperty("unlocked")||"Exchange"==s[a].type?s[a].type==e&&i++:i++);return i},findBuildingSlot:function(t){this.trace();var e=[],i=0;for(i=0;45>i;i++)e[i]=!0;if(t&&t.buildings)for(var s=t.buildings,a=0;a<s.length;a++)s[a].hasOwnProperty("slot")&&"neighborhood"==s[a].location&&(e[s[a].slot]=!1);for(i=0;i<e.length;i++)if(e[i])return i;return 0},addStat:function(t,e){this.options.stats||(this.options.stats={}),this.options.stats[t]||(this.options.stats[t]=0),this.options.stats[t]+=e,this.saveOptions(),this.updateStats()},parseData:function(t){var e,i,s;if(t){if("string"==typeof t&&(t=JSON.parse(t)),t.timestamp){var a=new Date,n=a.getTime()/1e3;this.time_diff=n-t.timestamp}if(t.cities&&t.cities[0]&&t.cities[0].id&&(this.cities||(this.cities=t.cities,this.signal("cities:update"))),t.neighborhoods)for(s in t.neighborhoods){var r=t.neighborhoods[s];if(r&&r.buildings&&r.buildings.length){var o=r.buildings;if(o[0]&&o[0].city_id&&(i=this.getCity(t.neighborhoods.neighborhood.buildings[0].city_id))){i.neighborhood||(i.neighborhood=[]),r.city=i;var d=!0;for(e=0;e<i.neighborhood.length;e++)if(i.neighborhood[e].id==r.id){d=!1;break}d&&i.neighborhood.push(r)}}}if(t.city&&(i=this.getCity(t.city.id))){if(i.data&&i.data.jobs&&t.city.jobs)for(e=0;e<i.data.jobs.length;e++){var l=!1;for(s=0;s<t.city.jobs.length;s++)if(i.data.jobs[e].queue==t.city.jobs[s].queue){l=!0;break}!l&&i.data.jobs[e].queue&&this.handleQueueComplete(i.data.jobs[e].queue)}i.data=t.city,this.signal("jobs:update"),t.city.figures&&t.city.figures.marches&&(i.maximum_troops=t.city.figures.marches.maximum_troops)}if(t.terrain){this.options.map||(this.options.map={});for(var u in t.terrain){var h=t.terrain[u];for(var c in h){var p=h[c];("Gang"==p[0]||"BossGang"==p[0])&&(this.options.map[p[2]]||(this.options.map[p[2]]={}),this.options.map[p[2]][p[3]]||(this.options.map[p[2]][p[3]]={}),this.options.map[p[2]][p[3]].lvl="Gang"==p[0]?p[1]:parseInt(p[1],10)+10,this.options.map[p[2]][p[3]].x=p[2],this.options.map[p[2]][p[3]].y=p[3])}}}if(t.has_free_ticket&&(this.free_ticket=t.has_free_ticket),t.items&&(this.items=t.items),t.level&&(this.player_level=t.level),t.result){if(t.result.prize_list)this.prizeList=t.result.prize_list,this.minigame_timestamp=t.result.minigame_timestamp;else if(t.result.item_won)for(var g in t.result.item_won)this.cities?this.updatePrizeInfo("Won: "+g,this.cities[0]):this.updatePrizeInfo("Won: "+g);if(t.result.prize)if(i=this.getCity(t.result.city_id),t.result.prize.prize_type)this.updatePrizeInfo("Won: "+t.result.prize.prize_type,i);else for(var m in t.result.prize)"cash_multiplier"!=m&&this.updatePrizeInfo("Won: "+m+" "+t.result.prize[m],i);if(t.result.job&&(i=this.getCity(t.result.job.city_id),i&&i.data&&(i.data.jobs||(i.data.jobs=[]),i.data.jobs.push(t.result.job),this.signal("jobs:update"))),this.lastCommand.city&&t.result.units&&(this.lastCommand.city.bailout=t.result.units,this.payBailout(this.lastCommand.city)),t.result.tokens&&(this.tokens=t.result.tokens),t.result.report_notifications&&(this.debugReport("Update reports"),this.reports={},this.reports.total=t.result.total,this.reports.reports=t.result.report_notifications,this.signal("report:update")),t.result.bonds_list)for(e=0;e<t.result.bonds_list.length;e++){var b=t.result.bonds_list[e];"BearerBond"==b.name&&100==b.quantity&&this.handleBonds()}}t.energy&&this.lastCommand.city&&(this.lastCommand.city.energy=t.energy)}},errorCommand:function(t){"string"==typeof t&&(t=JSON.parse(t)),this.debug("Error sending command"),this.debug(this.lastCommand),void 0!==this.lastCommand.callback&&this.lastCommand.callback()},revCommand:function(t){"string"==typeof t&&(t=JSON.parse(t)),t&&t.result&&(t.result.success||(this.debug("Command send Error: "+t.result.errors[0]),this.debug(this.lastCommand),this.lastCommand.city?this.loadCityData(this.lastCommand.city):this.loadPlayerData())),this.parseData(t),void 0!==this.lastCommand.callback&&this.lastCommand.callback()},checkCityQueue:function(t,e,i){this.trace();var s=!1;if(t&&t.data&&t.data.jobs){s=!0;for(var a=0;a<t.data.jobs.length;a++)if(void 0===i){if(t.data.jobs[a].queue&&t.data.jobs[a].queue==e){s=!1;break}}else if(t.data.jobs[a].city_building_id&&t.data.jobs[a].city_building_id==i){s=!1;break}if(s){var n=new Date,r=n.getTime(),o={run_at:r};void 0===i?o.queue=e:o.city_building_id=i,t.data.jobs.push(o)}}return s},loadCityData:function(t){if(this.trace(),t&&t.id){var e="unknown";t.data&&t.data.type&&(e=t.data.type),t.type&&(e=t.type),this.sendGetCommand("Load city "+e,"cities/"+t.id+".json","",t),this.sendGetCommand("Load city "+e+" neighborhood","cities/"+t.id+"/neighborhood_buildings.json","",t);var i=new Date;t.lastUpdate=i.getTime()}},loadCitiesData:function(){if(this.trace(),this.cities)for(var t=0;t<this.cities.length;t++)this.loadCityData(this.cities[t])},autoLoadCities:function(){if(this.trace(),this.cities)for(var t=0;t<this.cities.length;t++){var e=new Date;(!this.cities[t].lastUpdate||this.cities[t].lastUpdate<e.getTime()+300)&&this.loadCityData(this.cities[t])}},loadGameLoadedData:function(){if(this.trace(),this.cities&&this.cities[0]&&this.cities[0].id){for(var t=0;t<this.cities.length;t++)this.sendCommand("Load Game Data","player/game_loaded.json","_method=put",this.cities[t]);this.loadCitiesData()}},loadPlayerData:function(){this.trace(),this.sendGetCommand("Load Player","player.json")},loadPlayerDataInit:function(){this.trace();var t=this.bind(this.loadGameLoadedData);this.sendGetCommand("Load Player Init","player.json","",void 0,t)},enqueCommand:function(t,e,i,s,a,n,r){this.trace(),void 0!==a&&(""!==i&&(i+="&"),i+="city_id="+a.id);var o={};o.name=t,o.type=s,o.url=this.server+e,o.city=a,o.data=i+"&_session_id="+this.session+"&gangster="+this.gangster+"&user_id="+this.user,o.callback=n,r===!0?this.addToQueue(this.slow_queue,o):this.addToQueue(this.queue,o)},addToQueue:function(t,e){for(var i=0;i<t.length;i++)if(t[i].url==e.url&&t[i].data==e.data)return void this.debug("Dropping double command: "+e.name,e.city);t.push(e),this.signal("queue:update")},sendCommand:function(t,e,i,s,a){this.enqueCommand(t,e,i,"POST",s,a,!1)},sendGetCommand:function(t,e,i,s,a){this.enqueCommand(t,e,i,"GET",s,a,!1)},sendSlowCommand:function(t,e,i,s,a){this.enqueCommand(t,e,i,"POST",s,a,!0)},sendSlowGetCommand:function(t,e,i,s,a){this.enqueCommand(t,e,i,"GET",s,a,!0)},sendQueue:function(){this.queue.length>0?this.executeCommand(this.queue.shift()):this.slow_queue.length>0&&this.executeCommand(this.slow_queue.shift())},executeCommand:function(t){this.lastCommand=t,this.signal("queue:update");var e=this;$.ajax({type:this.lastCommand.type,url:this.lastCommand.url,data:this.lastCommand.data,success:function(t){e.revCommand(t)},error:function(t){e.errorCommand(t)}})},saveOptions:function(){localStorage.setItem("gfb_options",JSON.stringify(this.options))},loadOptions:function(){var t=localStorage.getItem("gfb_options");t?this.options=JSON.parse(t):this.options={}},trace:function(){this.enableTrace&&this.debug(arguments.callee.caller.name)},debug:function(t,e,i){var s=new Date;return"object"==typeof t&&(t=""),e&&e.data&&(t=e.data.type+": "+t),i&&(t=i+": "+t),t=s.toLocaleTimeString()+": "+t},generateDebugFunction:function(t){this["enableDebug"+t]=!1,this["debug"+t]=function(e,i){this["enableDebug"+t]&&this.debug(e,i,t)}},handleQueueComplete:function(t){this.trace(),"building"==t&&this.options.enableBuild?this.loadCitiesData():"research"==t&&this.options.enableResearch?this.doResearch():"units"==t&&this.options.enableTrain?this.doTrain():"defense_units"==t&&this.options.enableDefense?this.doDefense():-1!=t.indexOf("collect")&&this.options.enableCollect&&this.doCollect()},updateJobs:function(){var t=this.bind(this.main),e=1e3;if(this.cities)for(var i=new Date,s=i.getTime()/1e3,a=0;a<this.cities.length;a++){var n=this.cities[a];if(n&&n.data&&n.data.jobs)for(var r=0;r<n.data.jobs.length;r++){var o=n.data.jobs[r],d=o.run_at+this.time_diff;if(s>=d){this.loadCityData(n),n.data.jobs.splice(r,1),e=1e4,this.handleQueueComplete(o.queue);break}}}setTimeout(t,e)},init:function(t){this.loadOptions(),this.queue=[],this.slow_queue=[],this.lastCommand={},this.html={},this.enableTrace=!1,this.server=t.apiServer+"/",this.server=this.server.replace("http","https"),this.player=t.playerId,this.session=t.sessionId,this.user=t.userId,this.gangster=t.gangster;for(var e in this.autoFunctions)this.generateChangeEnable(e),this.generateAutoThread(e),this.generateDebugEnable(e),this.generateDebugFunction(e);this.loadPlayerDataInit(),this.drawPanel();var i=this.bind(this.sendQueue);setInterval(i,800);var s=this.bind(this.autoLoadCities);setInterval(s,6e4),this.updateJobs(),this.showMissingPrizeInfo()},start:function(){"undefined"!=typeof C?this.init(C.attrs):window.setTimeout(this.bind(this.start,this),1e3)}},buildBot={calcBuldingCost:function(t,e){return e*Math.pow(2,t-1)},hasResources:function(t,e,i,s,a){if(i&&t&&t.data&&t.data.resources){var n=t.data.resources;for(var r in i){var o=a(parseInt(s,10),i[r]);if(o>parseInt(n[r],10))return a==this.calcBuldingCost?this.debugBuild("Can't build "+e+" because "+r+" ("+o+") is more then "+n[r],t):this.debugResearch("Can't research "+e+" because "+r+" ("+o+") is more then "+n[r],t),!1}for(var d in i){var l=a(s,i[d]);t.data.resources[d]=parseInt(t.data.resources[d],10)-l}}else i?a==this.calcBuldingCost?this.debugBuild("Missing city data"):this.debugResearch("Missing city data"):a==this.calcBuldingCost?this.debugBuild("Missing cost for "+e):this.debugResearch("Missing cost for "+e);return!0},buildNewBuilding:function(t){if(this.trace(),t&&t.buildings&&t.city){var e=t.city;if("DoriaAirport"==e.type)return this.debugBuild("Do not build new building in Doria Airport",e),!1;var i=this.findBuildingLevel("Mansion",t.city),s=3*i+10,a=this.countBuilding(t);if(this.debugBuild("Man Level: "+i+" Total building: "+a+" => "+s,e),s>a){var n=this.findBuildingSlot(t),r="Hideout";for(var o in buildings){var d=buildings[o],l=0;if(this.options.build[o]?l=this.options.build[o]:d.buildNew&&(l=d.buildNew),l){var u=this.countBuilding(t,o);if(l>u){var h=d.cost;if(!this.hasResources(e,o,h,1,this.calcBuldingCost))continue;r=o;break}}}this.updateInfo("Build new "+r+" at slot "+n,e);var c="_method=post&city_building[building_type]="+r;return c+="&city_building[include_requirements]=false&city_building[instant_build]=false",c+="&city_building[neighborhood_id]="+t.id+"&city_building[slot]="+n,this.sendCommand("Build new "+r+" at slot "+n+" in "+e.type,"cities/"+e.id+"/buildings.json",c,e),this.addStat("Build",1),t.buildings.push({slot:n,location:"neighborhood",type:r}),!0}this.debugBuild("No more slots for new buildings ("+s+")",e)}else this.debugBuild("Can't find neighborhood or buildings",e);return!1},upgradeImportentBuilding:function(t,e){this.trace();for(var i=["Hideout","Apartment"],s=0;s<i.length;s++){var a=i[s],n=this.findBuildingLevel(a,t.city);if(9>n&&t&&t.buildings)for(var r=t.buildings,o=0;o<r.length;o++){var d=r[o];if(d.type==a&&d.level==n)return e.lvl=d.level,e.id=d.id,e.name=d.type,e.location=d.location,this.debugBuild("Build Importent "+e.name,t.city),e}}return this.debugBuild("Failed to find impotent building",t.city),e},upgradeLowestBuilding:function(t){if(this.trace(),this.buildNewBuilding(t))return!0;var e={};if(e.lvl=20,e.id="",e.location="",t&&t.buildings){for(var i=t.buildings,s=t.city,a=0;a<i.length;a++){var n=i[a];if(!n.hasOwnProperty("unlocked")&&n.level<9){var r=!0,o=i[n.type];if(o&&o.requirement){var d=o.requirement;if(d.build){var l=d.build[n.level];if(l)for(var u in l){var h=this.findBuildingLevel(u,t.city);if(h<l[u]){this.debugBuild("Can't build "+n.type+" because "+u+" is not "+l[u],s),r=!1;break}this.debugBuild(n.type+" has req "+u+" ("+l[u]+") and it is "+h,s)}}if(d.gangster&&d.gangster>this.player_level){this.debugBuild("Can't build "+n.type+" because gangster is not "+d.gangster,s),r=!1;break}d.gangster&&this.debugBuild(n.type+" has gangster "+d.gangster+" and we are "+this.player_level,s)}else this.debugBuild(n.type+" has no requirements",s);r&&o&&o.cost?this.hasResources(s,n.type,o.cost,n.level,this.calcBuldingCost)?this.debugBuild("Lots of resources",s):r=!1:r&&this.debugBuild("Not cost info for "+n.type,s),r&&(e.lvl>n.level||n.level>3&&e.lvl==n.level&&"neighborhood"==e.location)&&(e.lvl=n.level,e.id=n.id,e.name=n.type,e.location=n.location,e.building=n)}}if(20!=e.lvl){if(e.lvl>5){var c=this.upgradeImportentBuilding(t,e);this.hasResources(s,c.name,i[c.name].cost,c.lvl,this.calcBuldingCost)?e=c:this.debugBuild("Do not upgrade importent building, not egnogh rescources",s)}return this.updateInfo("Build "+e.name+" "+(e.lvl+1),s),this.sendCommand("Build "+e.name+" "+(e.lvl+1)+" in "+s.type,"cities/"+s.id+"/buildings/"+e.id+".json","_method=put",s),e.building.level++,!0}}return!1},doBuild:function(){if(this.trace(),this.cities)for(var t=0;t<this.cities.length;t++){var e=this.cities[t];if("DoriaAirport"==e.type)return void this.debugBuild("Build is disabled for Doria Airport",e);var i=this.checkCityQueue(e,"building");if(i)if(e.neighborhood)for(var s=0;s<e.neighborhood.length&&!this.upgradeLowestBuilding(e.neighborhood[s]);s++);else this.debugBuild("Neighborhood not ready",e);else this.debugBuild("Build queue not ready",e)}else this.debugBuild("Cities not ready")}},collectBot={doCollect:function(){if(this.trace(),this.cities)for(var t=0;t<this.cities.length;t++){var e=this.cities[t];if(e&&e.neighborhood)for(var i=0;i<e.neighborhood.length;i++){var s=e.neighborhood[i];if(s&&s.buildings)for(var a=s.buildings,n=0;n<a.length;n++){var r=a[n];if(r.hasOwnProperty("unlocked")&&r.unlocked){var o=this.checkCityQueue(s.city,void 0,r.id);if(o){this.debug("Collect "+r.type,e);var d="cities/"+s.city.id+"/npc_buildings/"+r.id+".json",l="_method=put&city_building_id="+r.id;this.sendCommand("Collect "+r.type+" in "+e.type,d,l,s.city),this.addStat("Collect",1)}}}}}return 1e3},doCityscape:function(){if(this.trace(),this.cities)for(var t=0;t<this.cities.length;t++){var e=this.cities[t];if(e&&e.data&&e.data.wildernesses&&e.data.wildernesses)for(var i=0;i<e.data.wildernesses.length;i++){var s=e.data.wildernesses[i];if(s)if("CityScape"==s.type){var a=new Date,n=a.getTime()/1e3,r=n-s.last_collected_at,o=21600;if(r>=o){this.debugCityscape("Collect cityscapes",e),this.sendCommand("Collect Cityscape in "+e.type,"cities/"+e.id+"/wildernesses/collect_all.json","",e),this.addStat("CityScape",1);break}this.debugCityscape("Diff is "+r+" < "+o)}else this.debugCityscape("Wild is "+s.type,e);else this.debugCityscape("Wild is empty",e)}else this.debugCityscape("Wilderness is not ready",e)}else this.debugCityscape("Cities is not ready");return 36e5},doExchange:function(){if(this.trace(),this.cities&&this.cities[0]&&this.cities[0].neighborhood&&this.cities[0].neighborhood.length){var t=this.cities[0];if(t&&t.neighborhood&&t.neighborhood.length)for(var e=0;e<this.cities[0].neighborhood.length;e++){var i=this.cities[0].neighborhood[e];if(i&&i.buildings)for(var s=0;s<i.buildings.length;s++)if("Exchange"==i.buildings[s].type){if(i.buildings[s].free_ticket){var a="cities/"+t.city_id+"/exchanges/"+i.buildings[s].id+"/collect.json",n="_method=put&_action=collect&city_building_id="+i.buildings[s].id;return this.sendCommand("Collect Exchange",a,n,this.cities[0]),i.buildings[s].free_ticket=!1,this.updateInfo("Collect Exchange"),this.addStat("Exchange",1),36e5}this.debugExchange("No free ticket",t)}else this.debugExchange("No Exchange building",t);else this.debugExchange("Buildings not ready",t)}else this.debugExchange("Neighborhod not ready",t)}else this.debugExchange("Cities not ready");return 0},doLoyaltyToken:function(){return this.trace(),this.cities&&this.cities[0]&&(this.debugLoyaltyToken("Checking token"),this.sendGetCommand("Update tokes","loyalty_tokens.json","",this.cities[0],this.bind(this.checkLoyalyToken))),36e5},checkLoyalyToken:function(){if(this.trace(),this.tokens)for(var t=0;t<this.tokens.length;t++)this.tokens[t].collectable&&(this.debugLoyaltyToken("Collect token"),this.sendCommand("Collect token","loyalty_tokens/collect.json","type="+this.tokens[t].type,this.cities[0]),this.addStat("Token",1))}},guiBot={addMissingPrizeInfo:function(t){this.options.missing_prize||(this.options.missing_prize=[]),this.options.missing_prize.push(t),this.saveOptions()},showMissingPrizeInfo:function(){if(this.trace(),this.options.missing_prize){this.debug("Show Missing prizes");for(var t=0;t<this.options.missing_prize.length;t++){var e=this.options.missing_prize[t];prizes[e]?this.options.missing_prize.splice(t,1):this.debug("Missing prize info: "+e)}this.saveOptions()}else this.debug("No missing prizes")},updatePrizeList:function(){this.trace();var t={cost:1e3,name:""};if(this.prizeList&&this.prizeList.length){for(var e=0;e<this.prizeList.length;e++)prizes[this.prizeList[e].type]?t.cost>prizes[this.prizeList[e].type]&&(t.cost=prizes[this.prizeList[e].type],t.name=this.prizeList[e].type):(this.updatePrizeInfo(this.prizeList[e].type+" is unknown"),
this.addMissingPrizeInfo(this.prizeList[e].type));t.cost>=10&&(this.getPrize(),this.free_ticket?this.free_ticket=!1:this.items&&this.items.DailyChance&&this.items.DailyChance>0&&this.items.DailyChance--,this.loadPlayerData())}},drawOption:function(t){var e=this.drawGenericOption(t,this.html.mainPanel,"enable_","changeEnable",this.options["enable"+t]),i=document.createElement("span");i.innerHTML=" - ",e.appendChild(i),this.drawButton(t+" Now",this.bind(this["do"+t]),e)},drawDebugOption:function(t){this.drawGenericOption(t,this.html.DebugInfoData,"enable_debug_","changeDebugEnable",!1)},drawGenericOption:function(t,e,i,s,a){var n=document.createElement("div");e.appendChild(n);var r=document.createElement("div");r.className="option",r.innerHTML=t+": ",n.appendChild(r);var o=document.createElement("input");return o.type="checkbox",o.name=i+t,o.id=i+t,o.checked=a,o.onclick=this.bind(this[s+t]),n.appendChild(o),this.html[i+t]=o,n},drawButton:function(t,e,i){var s=document.createElement("input");s.name=t,s.value=t,s.type="button",s.onclick=e,void 0===i?this.html.mainPanel.appendChild(s):i.appendChild(s)},drawTab:function(t,e){var i=document.createElement("a");return i.href="javascript:;",i.className="tabLink",i.id=t,i.innerHTML=e,i.onclick=function(){var t=$(this).attr("id");return $(".tabLink").removeClass("activeLink"),$(this).addClass("activeLink"),$(".tabcontent").addClass("hide"),$("#"+t+"_data").removeClass("hide"),!1},i},drawTabData:function(t){var e=document.createElement("div");return e.id=t+"_data",e.className="tabcontent hide",e},drawPanel:function(){var t=document.createElement("div");t.setAttribute("id","panel"),t.setAttribute("class","panel"),document.body.appendChild(t),this.html.panel=t;var e=document.createElement("p");e.className="header",e.innerHTML="The Underboss",e.onclick=function(){$("#panel").hasClass("panel")?($("#panel").removeClass("panel").addClass("hiddenPanel"),$("#mainPanel").hide()):($("#panel").removeClass("hiddenPanel").addClass("panel"),$("#mainPanel").show())},t.appendChild(e);var i=document.createElement("div");i.setAttribute("id","mainPanel"),this.html.panel.appendChild(i),this.html.mainPanel=i;for(var s in this.autoFunctions)this.drawOption(s);var a=document.createElement("div");i.appendChild(a);var n=document.createElement("div");n.className="tab-box",a.appendChild(n);for(var r=["Info","Prizes","Attack","Map","Train","Build","Debug"],o=0;o<r.length;o++){n.appendChild(this.drawTab("info-"+(o+1),r[o]));var d=this.drawTabData("info-"+(o+1));a.appendChild(d),this.html[r[o]+"InfoData"]=d,this["draw"+r[o]+"Tab"]&&this["draw"+r[o]+"Tab"](d)}this.listen("queue:update",this.updateDebugQueue)},drawDebugTab:function(t){$(t).html("<h7>Debug Info</h7>").append($("<div/>").attr("id","debug_jobs")).append($("<div/>").attr("id","debug_queue")),this.drawButton("Update Jobs",this.bind(this.loadCitiesData),t),this.drawButton("Execute",this.bind(this.executeCMD),t),this.drawButton("Trace",this.bind(this.toggleTrace),t);for(var e in this.autoFunctions)this.drawDebugOption(e);this.listen("jobs:update",this.updateDebug),this.listen("report:update",this.handleReport)},toggleTrace:function(){this.enableTrace=!this.enableTrace},executeCMD:function(){var cmd=window.prompt("Enter CMD","");try{var res=eval(cmd);res&&this.debug(res)}catch(t){alert(t)}},updateDebugQueue:function(){$("#debug_queue").html("<h7>Queue: "+this.queue.length+"</h7><h7>Slow Queue: "+this.slow_queue.length+"</h7>")},updateDebug:function(){var t=$("#debug_jobs").html("<h7>Jobs</h7>");if(this.cities)for(var e=0;e<this.cities.length;e++){var i=this.cities[e];if(i&&i.data&&i.data.jobs){for(var s=r=u=d="&nbsp;",a=0;a<i.data.jobs.length;a++)"research"==i.data.jobs[a].queue&&(r="R"),"building"==i.data.jobs[a].queue&&(s="B"),"units"==i.data.jobs[a].queue&&(u="U"),"defense_units"==i.data.jobs[a].queue&&(d="D");t.append("<h7>"+i.type+" ("+i.data.jobs.length+") "+s+" "+r+" "+u+" "+d+"</h7>")}}},drawBuildTab:function(t){this.html.build={},this.options.build||(this.options.build={}),t.innerHTML="<h7>Build Orders</h7><p>Build this amount of buildings and the rest will be Hideout.</p>";var e=document.createElement("table");t.appendChild(e);var i=!1;for(var s in buildings)if(buildings[s].buildNew){var a=document.createElement("tr");e.appendChild(a);var n=document.createElement("td");n.innerHTML=s,a.appendChild(n),n=document.createElement("td"),a.appendChild(n);var r=document.createElement("input");this.options.build.hasOwnProperty(s)&&"number"==typeof this.options.build[s]?r.value=this.options.build[s]:(r.value=buildings[s].buildNew,i=!0),this.html.build[s]=r,n.appendChild(r)}i&&this.saveBuildOrder(),this.drawButton("Save",this.bind(this.saveBuildOrder),t)},saveBuildOrder:function(){this.options.build={};for(var t in buildings)buildings[t].buildNew&&(this.options.build[t]=parseInt(this.html.build[t].value,10));this.saveOptions()},drawTrainTab:function(t){t.innerHTML="<h7>Training Orders</h7>";var e=$("<table/>");$(t).append(e);var i,s=0;for(var a in attackUnits)s%2===0&&(i=$("<tr/>"),e.append(i)),i.append($("<td/>").text(a).append($("<td/>").append($("<input class='number'/>").attr("id","unit_"+a)))),this.options.trainOrders&&this.options.trainOrders[a]&&$("#unit_"+a).val(this.options.trainOrders[a]),s++;this.drawButton("Save",this.bind(this.saveTrainOrder),t)},saveTrainOrder:function(){this.trace(),this.options.trainOrders||(this.options.trainOrders={});for(var t in attackUnits)this.options.trainOrders[t]=$("#unit_"+t).val();this.saveOptions()},drawMapInfo:function(){this.html.map_info||(this.html.map_info=document.createElement("div"),this.html.MapInfoData.appendChild(this.html.map_info)),this.options.map_size||(this.options.map_size=2,this.updateMap()),this.html.map_info.innerHTML="<p>Scan size: "+this.options.map_size+"</p>";var t,e,i={};for(e in this.options.map)for(var s in this.options.map[e]){var a=this.options.map[e][s];i[a.lvl]||(i[a.lvl]=0),i[a.lvl]++}for(t=1;10>=t;t++)i[t]&&(this.html.map_info.innerHTML+="<p>Lvl "+t+" Gangs: "+i[t]+"</p>");for(t=1;5>=t;t++)i[10+t]&&(this.html.map_info.innerHTML+="<p>Murder Inc. "+t+": "+i[10+t]+"</p>")},drawMapTab:function(t){t.innerHTML="<h7>Map</h7>",this.drawButton("Update Map",this.bind(this.updateMap),t),this.drawMapInfo()},drawAttackTab:function(t){this.html.order={},t.innerHTML="<h7>Attack Orders</h7>",$("<div>City:</div>").append($('<select id="select_attack_city"></select>')).appendTo($(t)),this.listen("cities:update",function(){var t=$("#select_attack_city");if(t.empty(),t.append($('<option value="all">All</option>')),this.cities)for(var e=0;e<this.cities.length;e++)t.append($('<option value="'+this.cities[e].type+'">'+this.cities[e].type+"</option>"))}),$("<div>Gang Level:</div>").append($('<select id="select_gang"></select>')).appendTo($(t));for(var e=$("#select_gang"),i=1;15>=i;i++)e.append($('<option value="'+i+'">'+i+"</option>"));$('<div id="units_p">Units:</div>').append($('<select id="select_units"></select>')).appendTo($(t));var s=$("#select_units");for(var a in attackUnits)s.append($('<option value="'+a+'">'+a+"</option>"));$('<input type="text" id="unit_count" value="0" class="unit_count" />').appendTo($("#units_p")),this.drawButton("Add",this.bind(this.addUnitToAttackOrder),document.getElementById("units_p")),$("<div>Use All:</div>").append('<input type="checkbox" id="check_attack_all" value="all"/>').appendTo($(t)),$('<textarea id="total_units" class="textinfo"></textarea>').appendTo($(t)),this.drawButton("Save",this.bind(this.saveAttackOrder),t),this.drawButton("Clear",this.bind(this.clearAttackOrder),t);var n=document.createElement("hr");t.appendChild(n);var r=document.createElement("select");r.size="10",r.width="100%",t.appendChild(r),this.html.order.list=r,this.drawButton("Delete",this.bind(this.deleteAttackOrder),t),this.updateAttackOrders()},deleteAttackOrder:function(){var t=this.html.order.list.value;this.options.attackOrders.splice(t,1),this.updateAttackOrders()},updateAttackOrders:function(){if(this.html.order.list.innerHTML="",this.options.attackOrders)for(var t=0;t<this.options.attackOrders.length;t++){var e=this.options.attackOrders[t];e.city||(e.city="all"),e.use_all||(e.use_all=!1);var i=document.createElement("option");this.html.order.list.appendChild(i),i.value=t,i.innerHTML=e.city+" | "+e.gang+" | "+(e.use_all?"t":"f")+" | "+e.units}},addUnitToAttackOrder:function(){var t=$("#total_units");""!==t.val()&&t.val(t.val()+","),t.val(t.val()+'"'+$("#select_units").val()+'":'+$("#unit_count").val())},saveAttackOrder:function(){var t={};t.gang=parseInt($("#select_gang").val(),10),t.units="{"+$("#total_units").val()+"}",t.city=$("#select_attack_city").val(),t.use_all=$("#check_attack_all").is(":checked"),this.options.attackOrders||(this.options.attackOrders=[]),this.options.attackOrders.push(t),this.saveOptions(),this.clearAttackOrder(),this.updateAttackOrders()},clearAttackOrder:function(){$("#total_units").val("")},updateStats:function(){var t=$("#stats").html("<h3><u>Stats</u></h3>");if(this.options.stats)for(var e in this.options.stats)t.append($("<p>"+e+": "+this.options.stats[e]+"</p>"))},drawInfoTab:function(t){$(t).append($("<div></div>").addClass("stats").attr("id","stats")),this.updateStats(),$(t).append($("<textarea></textarea>").addClass("info").attr("id","debug_info"))},drawPrizesTab:function(t){$(t).html("<h7>Prizes</h7>").append("<p>Prize Info:</p>").append($("<textarea/>").addClass("prize_info"))},updateInfo:function(t,e){$("#debug_info").text(this.debug(t,e)+"\n"+$("#debug_info").text())},updatePrizeInfo:function(t,e){$(".prize_info").text(this.debug(t,e)+"\n"+$(".prize_info").text())}},itemBot={doItems:function(){if(this.items)if(this.cities){for(var t=this.cities[0],e=0;e<collect.length;e++)this.items[collect[e]]&&(this.debugItems(collect[e]+": "+this.items[collect[e]]),this.items[collect[e]]--,this.sendCommand("Collect "+collect[e],"player_items/"+collect[e]+".json","_method=delete",t),this.addStat("Item",1));this.loadPlayerData()}else this.debugItems("Cities is not ready");else this.debugItems("Items is not ready")}},prizeBot={getPrize:function(){this.trace(),this.cities&&this.cities[0]&&this.minigame_timestamp&&(this.debugPrize("Get Prize"),this.sendCommand("Get Prize","minigames/save_result.json","minigame_timestamp="+this.minigame_timestamp,this.cities[0]),this.addStat("Prize",1))},doPrize:function(){if(this.trace(),this.cities&&this.cities[0]){if(!(this.free_ticket||this.items&&this.items.DailyChance&&this.items.DailyChance>0))return this.debugPrize("No prize ticket - Update player data"),this.loadPlayerData(),3e5;this.debugPrize("Update Prize"),this.sendGetCommand("Update Prize","minigames/index.json","",this.cities[0],this.bind(this.updatePrizeList))}else this.debugPrize("Cities not ready");return 0}},reportBot={doReport:function(){this.debugReport("Do Reports"),this.sendGetCommand("Reports","reports.json","count=18&page=1&category=reports")},handleReport:function(){if(this.debugReport("Handle Reports"),this.reports&&this.reports.reports){for(var t="",e=0;e<this.reports.reports.length;e++){var i=this.reports.reports[e];"attacking"==i.battle_side&&"Won"==i.battle_result&&null===i.read_at&&(t+=i.id+"|")}this.debugReport("Ids: "+t),""!==t&&this.sendCommand("Delete reports","reports/bulk_delete.json","_method=delete&ids="+t)}}},researchBot={calcReseachCost:function(t,e){for(var i=1;t>i;i++)e*=1.5;return e},researchLowest:function(t){this.trace();var e={lvl:20,pri:20,id:""};if(t&&t.data&&t.data.research&&t.neighborhood)for(var i in research){var s=t.data.research[i],a=!1;if(void 0===s&&(s=0),research[i]){var n=research[i];if(n.requirement){var r=n.requirement;if(r){if(r.build){var o=this.findBuildingLevel(r.build,t);this.debugResearch(i+" ("+s+"/"+(s-4)+") has req "+r.build+" and it is "+o+" ("+4*o+")",t),o*="Garage"==r.build||"Workshop"==r.build||"GuardPost"==r.build?4:2,s>1&&s>=o&&(this.debugResearch("skip because "+o+" is less then "+s,t),a=!0)}if(!a&&r.research)for(var d=0;d<r.research.length;d++){var l=r.research[d],u=t.data.research[l];void 0===u&&(u=0),this.debugResearch(i+" has req "+l+" and it is "+u,t),s>=u&&(this.debugResearch("Skip because "+u+" is less then "+s,t),a=!0)}}}a||this.hasResources(t,i,n.cost,s,this.calcReseachCost)||(this.debugResearch("Skip because we can't affort it",t),a=!0)}a||(e.lvl>s||e.lvl==s&&e.pri>research[i].priority)&&(e.lvl=s,e.name=i,e.pri=research[i].priority)}20!=e.lvl&&(this.updateInfo("Research "+e.name+" lvl "+(e.lvl+1),t),this.sendCommand("Research "+e.name+" lvl "+(e.lvl+1)+" in "+t.type,"cities/"+t.id+"/researches.json","research[research_type]="+e.name,t),this.addStat("Research",1),t.data.research[e.name]=e.lvl+1)},doResearch:function(){if(this.trace(),this.cities)for(var t=0;t<this.cities.length;t++){var e=this.cities[t];if("DoriaAirport"!=e.type){var i=this.checkCityQueue(e,"research");i?this.researchLowest(e):this.debugResearch("Already researching",e)}}}},trainBot={doTrain:function(){if(this.trace(),this.cities&&this.options.trainOrders){this.debugTrain(this.options.trainOrders);for(var t=0;t<this.cities.length;t++){var e=this.cities[t];if("DoriaAirport"!=e.type)for(var i in attackUnits){var s=this.options.trainOrders[i];if(s)if(e&&e.data&&e.data.units){var a=10,n=0;if(e.data.units[i]&&(n=e.data.units[i]),n>=s)this.debugTrain("Do not train "+i+", there is "+n,e);else{if(this.checkCityQueue(e,"units")){this.debugTrain("Train "+a+" "+i,e),this.sendTrainOrders(i,a,e),this.addStat("Train",a);break}this.debugTrain("Already training units",e)}}else this.debugTrain("Data is missing",e);else this.debugTrain("Do not train "+s+" "+i,e)}}}else this.debugTrain("Train data is not ready")},doDefense:function(){if(this.trace(),this.cities)for(var t=0;t<this.cities.length;t++){var e=this.cities[t];if("DoriaAirport"!=e.type)if(this.checkCityQueue(e,"defense_units")){var i=void 0;for(var s in defenseUnits){var a=!1,n=defenseUnits[s].requirement;if(n.build)for(var r in n.build){var o=this.findBuildingLevel(r,e);if(this.debugDefense(s+" has build req "+r+" of "+n.build[r]+" and it is "+o,e),o<n.build[r]){this.debugDefense("Skipping",e),a=!0;break}}if(!a&&n.research)for(var d in n.research){var l=e.data.research[d];if(void 0===l&&(l=0),this.debugDefense(s+" has req "+d+" of "+n.research[d]+" and it is "+l,e),l<n.research[d]){this.debugDefense("Skiping",e),a=!0;break}}a||(i=s,this.debugDefense("Can build "+s,e))}if(i){var u=10;this.sendTrainOrders(i,u,e),this.debugTrain("Train "+u+" "+s,e),this.addStat("Defense",u)}else this.debugDefense("Failed to find a unit to train",e)}else this.debugDefense("Already training defense units",e)}},sendTrainOrders:function(t,e,i){this.sendCommand("Train "+e+" "+t+" in "+i.type,"cities/"+i.id+"/units.json","_method=post&units[include_requirements]=false&units[quantity]="+e+"&units[unit_type]="+t,i)}};$&&$("#game_frame")&&($("#game_frame").width("1281px"),setTimeout(function(){location.reload()},72e5));var css=GM_getResourceText("underbossCSS");if(GM_addStyle(css),-1!=window.location.href.indexOf("platforms/kabam/game")){injectVariable("attackUnits",attackUnits),injectVariable("defenseUnits",defenseUnits),injectVariable("buildings",buildings),injectVariable("research",research),injectVariable("prizes",prizes),injectVariable("collect",collect),combine(bot,attackBot,bondsBot,buildBot,guiBot,itemBot,reportBot,trainBot,bailoutBot,collectBot,prizeBot,researchBot);var src=convertToText(bot);src="var bot = "+src+";\n",src+="bot.start();",inject(src)}